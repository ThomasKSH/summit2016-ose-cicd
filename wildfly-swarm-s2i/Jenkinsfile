node {
    
    env.KUBECONFIG = pwd() + "/.kubeconfig"
    def infraProject = "swarm-infra"
    def swarmBase = "swarm-s2i"
    def WORKSPACE = pwd()
    
    stage 'Checkout'
    
      git url: "http://gogs:3000/gogs/wildfly-swarm-s2i.git"
      
    stage 'Update BuildConfig Version'
      
      def finalTagVersion = parseVersion("${WORKSPACE}/version.txt")
      
      def buildVersion = "${finalTagVersion}-\${BUILD_NUMBER}"
      
      login()
      
      sh """
       set +x 
      
       currentOutputName=\$(oc get bc ${swarmBase} -n ${infraProject} --template='{{ .spec.output.to.name }}')
       
       newImageName=\${currentOutputName%:*}:${buildVersion}
       
       oc patch bc ${swarmBase} -n ${infraProject} -p "{ \\"spec\\": { \\"output\\": { \\"to\\": { \\"name\\": \\"\${newImageName}\\" } } } }"
       
      """
    stage "Build Image"
    
    
      login()
      
      sh """
        set +x
        oc start-build ${swarmBase} -n ${infraProject} --follow=true --wait=true --from-dir="${WORKSPACE}/"
      """
    stage "Tagging Image"
      login()
      
      sh """
        set +x
        oc tag ${infraProject}/${swarmBase}:${buildVersion} ${infraProject}/${swarmBase}:${finalTagVersion}
        
        oc tag ${infraProject}/${swarmBase}:${finalTagVersion} openshift/${swarmBase}:${finalTagVersion}
      """
}

def login() {
    sh """
       set +x
       oc login --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt --token=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) https://kubernetes.default.svc.cluster.local >/dev/null 2>&1 || echo 'OpenShift login failed'
       """
}

def parseVersion(String filename) {
    def version = readFile(filename)
    version.trim()
}